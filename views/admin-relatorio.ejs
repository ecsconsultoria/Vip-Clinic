<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>Relat√≥rio - <%= company.name %> Admin</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="/css/admin-mobile.css">
  <script>
    // Garantir que todos os modais comecem fechados
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Iniciando p√°gina - fechando todos os modais');
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        modal.style.display = 'none';
        console.log('Modal fechado:', modal.id);
      });
    });
  </script>
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1><%= company.name %></h1>
        <p>Admin</p>
      </div>
      
      <nav class="sidebar-nav">
        <a href="/admin/dashboard" class="nav-item">üìä Dashboard</a>
        <a href="/admin/relatorio" class="nav-item active">üìà Relat√≥rio</a>
        <button type="button" class="nav-item" onclick="openAvailabilityModal(event)">üïê Gerenciar Hor√°rios</button>
        <button type="button" class="nav-item" onclick="openCapacityModal(event)">üéØ Gerenciar Vagas</button>
        <button type="button" class="nav-item" onclick="openPasswordModal(event)">üîí Alterar Senha</button>
        <button type="button" class="nav-item" onclick="generateLink(event)">üîó Gerar Link</button>
        <a href="/admin/login" class="nav-item">üö™ Sair</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-header">
        <h1>üìä Relat√≥rio de Agendamentos</h1>
        <p>Resumo completo por data com filtros</p>
      </div>

      <!-- Resumo por Data -->
      <div class="appointments-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>üìä Resumo por Data</h2>
          
          <div style="display: flex; gap: 10px; align-items: center;">
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="font-weight: 600; color: #495057;">De:</label>
              <input type="date" id="filterDateStart" style="padding: 8px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
            </div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="font-weight: 600; color: #495057;">At√©:</label>
              <input type="date" id="filterDateEnd" style="padding: 8px 12px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px;">
            </div>
            <button onclick="filterDateRange()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
              üîç Filtrar
            </button>
            <button onclick="clearDateFilter()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
              ‚úñÔ∏è Limpar
            </button>
            <button onclick="exportToExcel()" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
              üì• Exportar Excel
            </button>
          </div>
        </div>
        
        <% if (dailySummary && dailySummary.length > 0) { %>
          <div class="table-responsive">
            <table class="appointments-table summary-table">
              <thead>
                <tr style="background: #f8f9fa;">
                  <th>üìÖ Data</th>
                  <th>üìã Total</th>
                  <th style="color: #6c757d;">üí∞ Valor Previsto</th>
                  <th style="color: #28a745;">üíµ Valor Realizado</th>
                  <th>üè∑Ô∏è Status</th>
                </tr>
              </thead>
              <tbody>
                <% dailySummary.forEach(day => { %>
                  <% 
                    const [year, month, dayNum] = day.date.split('-');
                    const formattedDate = `${dayNum}/${month}/${year}`;
                  %>
                  <tr style="cursor: pointer;" onclick="toggleDateDetails('<%= day.date %>')">
                    <td><strong><%= formattedDate %></strong></td>
                    <td><span class="badge" style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 4px;"><%= day.total %></span></td>
                    <td style="font-weight: bold; color: #6c757d;">R$ <%= day.totalValue.toFixed(2) %></td>
                    <td style="font-weight: bold; color: #28a745; font-size: 16px;">R$ <%= day.completedValue.toFixed(2) %></td>
                    <td>
                      <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <% if (day.confirmed > 0) { %><span class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><%= day.confirmed %> Agendado(s)</span><% } %>
                        <% if (day.completed > 0) { %><span class="badge" style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><%= day.completed %> Finalizado(s)</span><% } %>
                        <% if (day.cancelled > 0) { %><span class="badge" style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><%= day.cancelled %> Cancelado(s)</span><% } %>
                      </div>
                    </td>
                  </tr>
                  <tr id="details-<%= day.date %>" style="display: none; background: #f8f9fa;">
                    <td colspan="5" style="padding: 0;">
                      <table style="width: 100%; border-collapse: collapse;">
                        <tbody>
                          <% day.appointments.forEach(apt => { %>
                            <tr style="border-bottom: 1px solid #dee2e6;">
                              <td style="padding: 8px 12px; width: 20%;"><strong><%= apt.appointment_time %></strong> - <%= apt.client_name %></td>
                              <td style="padding: 8px 12px; width: 20%;"><%= formatServiceName(apt.service) %></td>
                              <td style="padding: 8px 12px; width: 20%; font-weight: bold; color: #6c757d;">R$ <%= (apt.service_price || 0).toFixed(2) %></td>
                              <td style="padding: 8px 12px; width: 20%; font-weight: bold; color: <%= apt.status === 'completed' ? '#28a745' : '#999' %>;">
                                <%= apt.status === 'completed' ? 'R$ ' + (apt.service_price || 0).toFixed(2) : '‚Äî' %>
                              </td>
                              <td style="padding: 8px 12px; width: 20%;">
                                <span class="status-badge <%= apt.status %>" style="font-size: 11px; padding: 4px 8px;">
                                  <%= formatStatus(apt.status) %>
                                </span>
                              </td>
                            </tr>
                          <% }); %>
                        </tbody>
                      </table>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
              <tfoot>
                <tr style="background: #e9ecef; font-weight: bold;">
                  <td>TOTAL GERAL</td>
                  <td><%= dailySummary.reduce((sum, d) => sum + d.total, 0) %></td>
                  <td style="color: #6c757d;">R$ <%= dailySummary.reduce((sum, d) => sum + d.totalValue, 0).toFixed(2) %></td>
                  <td style="color: #28a745; font-size: 18px;">R$ <%= dailySummary.reduce((sum, d) => sum + d.completedValue, 0).toFixed(2) %></td>
                  <td>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                      <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><%= dailySummary.reduce((sum, d) => sum + d.confirmed, 0) %> Agendado(s)</span>
                      <span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><%= dailySummary.reduce((sum, d) => sum + d.completed, 0) %> Finalizado(s)</span>
                      <span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;"><%= dailySummary.reduce((sum, d) => sum + d.cancelled, 0) %> Cancelado(s)</span>
                    </div>
                  </td>
                </tr>
              </tfoot>
            </table>
          </div>
        <% } else { %>
          <p class="no-data">Nenhum agendamento para resumir.</p>
        <% } %>
      </div>
    </main>
  </div>

  <!-- Modal para Gerenciar Hor√°rios -->
  <div id="availabilityModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAvailabilityModal()">&times;</span>
      <h2>üïê Gerenciar Hor√°rios e Datas</h2>
      
      <div class="availability-controls">
        <h3>Bloquear Hor√°rio Espec√≠fico</h3>
        <div class="form-group">
          <label>Data:</label>
          <input type="date" id="unavailDate" required>
        </div>
        <div class="form-group">
          <label>Hor√°rio:</label>
          <select id="unavailTime" required>
            <option value="">Selecione</option>
            <option value="09:00">09:00 - 10:00</option>
            <option value="10:00">10:00 - 11:00</option>
            <option value="11:00">11:00 - 12:00</option>
            <option value="12:00">12:00 - 13:00</option>
            <option value="13:00">13:00 - 14:00</option>
            <option value="14:00">14:00 - 15:00</option>
            <option value="15:00">15:00 - 16:00</option>
            <option value="16:00">16:00 - 17:00</option>
            <option value="17:00">17:00 - 18:00</option>
          </select>
        </div>
        <div class="form-group">
          <label>Motivo (opcional):</label>
          <input type="text" id="unavailReason" placeholder="Ex: Manuten√ß√£o, Feriado, etc">
        </div>
        <button onclick="blockTimeSlot()" class="btn btn-primary">üîí Bloquear Hor√°rio</button>
      </div>

      <hr style="margin: 20px 0;">

      <div class="availability-controls">
        <h3>Bloquear Data Inteira</h3>
        <div class="form-group">
          <label>Data:</label>
          <input type="date" id="unavailFullDate" required>
        </div>
        <div class="form-group">
          <label>Motivo:</label>
          <input type="text" id="unavailFullReason" placeholder="Ex: Fechado, Feriado, Evento">
        </div>
        <button onclick="blockFullDate()" class="btn btn-danger">üö´ Bloquear Data Inteira</button>
      </div>

      <hr style="margin: 20px 0;">

      <div class="unavailable-list">
        <h3>Hor√°rios/Datas Bloqueadas</h3>
        <div id="unavailableSlotsList" class="slots-list">
          <p>Carregando...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Gerenciar Capacidade de Vagas -->
  <div id="capacityModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeCapacityModal()">&times;</span>
      <h2>üéØ Gerenciar Vagas por Servi√ßo</h2>
      <p>Configure o n√∫mero m√°ximo de vagas simult√¢neas para cada servi√ßo</p>
      
      <div class="capacity-table">
        <table class="appointments-table">
          <thead>
            <tr>
              <th>Servi√ßo</th>
              <th>Vagas Dispon√≠veis</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="capacityTableBody">
            <tr><td colspan="3" style="text-align: center;">Carregando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal para Alterar Senha -->
  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closePasswordModal()">&times;</span>
      <h2>üîí Alterar Senha do Administrador</h2>
      <p class="modal-description">Altere a senha de acesso ao painel administrativo</p>
      
      <form id="passwordForm" onsubmit="changePassword(event)">
        <div class="form-group">
          <label>üîê Senha Atual:</label>
          <input type="password" id="currentPassword" required minlength="6" placeholder="Digite a senha atual">
        </div>
        
        <div class="form-group">
          <label>üîë Nova Senha:</label>
          <input type="password" id="newPassword" required minlength="6" placeholder="M√≠nimo 6 caracteres">
        </div>
        
        <div class="form-group">
          <label>‚úÖ Confirmar Nova Senha:</label>
          <input type="password" id="confirmPassword" required minlength="6" placeholder="Digite novamente a nova senha">
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">üíæ Alterar Senha</button>
          <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">‚ùå Cancelar</button>
        </div>
      </form>
      
      <div id="passwordMessage" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
    </div>
  </div>

  <!-- Modal para Link -->
  <div id="linkModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeLinkModal()">&times;</span>
      <h2>Link de Agendamento</h2>
      <p>Compartilhe este link com seus clientes:</p>
      
      <div class="link-box">
        <input type="text" id="bookingLink" readonly>
        <button onclick="copyLink()" class="btn btn-small">üìã Copiar</button>
      </div>

      <div class="link-box">
        <label>Ou compartilhe direto no WhatsApp:</label>
        <a id="whatsappLink" href="#" target="_blank" class="btn btn-primary">
          üí¨ Abrir WhatsApp
        </a>
      </div>
    </div>
  </div>

  <script>
    // Fun√ß√µes auxiliares de formata√ß√£o
    function formatServiceName(service) {
      const serviceMap = {
        'manicure': 'Manicure',
        'pedicure': 'Pedicure',
        'manicure_pedicure': 'Manicure + Pedicure',
        'cilios': 'Design de Sobrancelhas + C√≠lios',
        'manicure_cilios': 'Manicure + C√≠lios',
        'pedicure_cilios': 'Pedicure + C√≠lios',
        'completo': 'Completo (Manicure + Pedicure + C√≠lios)'
      };
      return serviceMap[service] || service;
    }

    function formatStatus(status) {
      const statusMap = {
        'confirmed': 'Agendado',
        'completed': 'Finalizado',
        'cancelled': 'Cancelado'
      };
      return statusMap[status] || status;
    }
    // Expandir/Recolher detalhes por data
    function toggleDateDetails(date) {
      const detailsRow = document.getElementById('details-' + date);
      if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
      } else {
        detailsRow.style.display = 'none';
      }
    }

    // Fun√ß√µes de filtro de data
    function filterDateRange() {
      const startDate = document.getElementById('filterDateStart').value;
      const endDate = document.getElementById('filterDateEnd').value;
      
      if (!startDate && !endDate) {
        alert('‚ö†Ô∏è Por favor, selecione pelo menos uma data (in√≠cio ou fim)');
        return;
      }
      
      const rows = document.querySelectorAll('.summary-table tbody tr:not([id^="details-"])');
      let visibleCount = 0;
      
      rows.forEach(row => {
        const dateCell = row.querySelector('td:first-child strong');
        if (!dateCell) return;
        
        const dateText = dateCell.textContent.trim();
        const [day, month, year] = dateText.split('/');
        const rowDate = `${year}-${month}-${day}`;
        
        let shouldShow = true;
        
        if (startDate && rowDate < startDate) {
          shouldShow = false;
        }
        
        if (endDate && rowDate > endDate) {
          shouldShow = false;
        }
        
        if (shouldShow) {
          row.style.display = '';
          visibleCount++;
        } else {
          row.style.display = 'none';
          // Esconder tamb√©m a linha de detalhes correspondente
          const detailsRow = document.getElementById('details-' + rowDate);
          if (detailsRow) {
            detailsRow.style.display = 'none';
          }
        }
      });
      
      // Atualizar totais do rodap√©
      updateFooterTotals();
      
      // Mostrar mensagem
      const message = visibleCount === 0 
        ? '‚ùå Nenhum agendamento encontrado no per√≠odo selecionado' 
        : `‚úÖ Mostrando ${visibleCount} dia(s) com agendamentos`;
      
      showFilterMessage(message, visibleCount > 0);
    }
    
    function clearDateFilter() {
      document.getElementById('filterDateStart').value = '';
      document.getElementById('filterDateEnd').value = '';
      
      const rows = document.querySelectorAll('.summary-table tbody tr');
      rows.forEach(row => {
        row.style.display = row.id && row.id.startsWith('details-') ? 'none' : '';
      });
      
      updateFooterTotals();
      showFilterMessage('üîÑ Filtro removido - mostrando todos os agendamentos', true);
    }

    function exportToExcel() {
      const startDate = document.getElementById('filterDateStart').value;
      const endDate = document.getElementById('filterDateEnd').value;
      
      let url = '/admin/export-relatorio';
      const params = new URLSearchParams();
      
      if (startDate) params.append('startDate', startDate);
      if (endDate) params.append('endDate', endDate);
      
      if (params.toString()) {
        url += '?' + params.toString();
      }
      
      window.location.href = url;
    }
    
    function updateFooterTotals() {
      const visibleRows = Array.from(document.querySelectorAll('.summary-table tbody tr:not([id^="details-"])'))
        .filter(row => row.style.display !== 'none');
      
      let totals = {
        total: 0,
        confirmed: 0,
        completed: 0,
        cancelled: 0,
        totalValue: 0,
        completedValue: 0
      };
      
      visibleRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        totals.total += parseInt(cells[1].textContent.trim()) || 0;
        
        const totalValueText = cells[2].textContent.replace('R$', '').replace(',', '.').trim();
        totals.totalValue += parseFloat(totalValueText) || 0;
        
        const completedValueText = cells[3].textContent.replace('R$', '').replace(',', '.').trim();
        totals.completedValue += parseFloat(completedValueText) || 0;
        
        // Extrair n√∫meros dos badges de status na c√©lula 4
        const statusCell = cells[4];
        const badges = statusCell.querySelectorAll('.badge, span[style*="background"]');
        badges.forEach(badge => {
          const text = badge.textContent.trim();
          const num = parseInt(text.match(/\d+/)?.[0]) || 0;
          if (text.includes('Agendado')) totals.confirmed += num;
          if (text.includes('Finalizado')) totals.completed += num;
          if (text.includes('Cancelado')) totals.cancelled += num;
        });
      });
      
      // Atualizar c√©lulas do rodap√©
      const footerCells = document.querySelectorAll('.summary-table tfoot td');
      if (footerCells.length >= 5) {
        footerCells[1].textContent = totals.total;
        footerCells[2].textContent = 'R$ ' + totals.totalValue.toFixed(2);
        footerCells[3].textContent = 'R$ ' + totals.completedValue.toFixed(2);
        
        // Atualizar badges de status no rodap√©
        const statusDiv = footerCells[4].querySelector('div');
        if (statusDiv) {
          statusDiv.innerHTML = `
            <span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">${totals.confirmed} Agendado(s)</span>
            <span style="background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">${totals.completed} Finalizado(s)</span>
            <span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px;">${totals.cancelled} Cancelado(s)</span>
          `;
        }
      }
    }
    
    function showFilterMessage(message, isSuccess) {
      // Remover mensagem anterior se existir
      const existingMsg = document.getElementById('filterMessage');
      if (existingMsg) existingMsg.remove();
      
      const msgDiv = document.createElement('div');
      msgDiv.id = 'filterMessage';
      msgDiv.textContent = message;
      msgDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${isSuccess ? '#28a745' : '#dc3545'};
        color: white;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        animation: slideIn 0.3s ease;
      `;
      
      document.body.appendChild(msgDiv);
      
      setTimeout(() => {
        msgDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => msgDiv.remove(), 300);
      }, 3000);
    }

    // Fun√ß√£o para gerar link
    function generateLink(e) {
      if (e) e.preventDefault();
      
      fetch('/admin/generate-link')
        .then(response => response.json())
        .then(data => {
          document.getElementById('bookingLink').value = data.link;
          document.getElementById('whatsappLink').href = data.whatsapp;
          document.getElementById('linkModal').style.display = 'block';
        })
        .catch(error => {
          alert('‚ùå Erro ao gerar link. Tente novamente.');
          console.error(error);
        });
    }

    function closeLinkModal() {
      document.getElementById('linkModal').style.display = 'none';
    }

    function copyLink() {
      const linkInput = document.getElementById('bookingLink');
      const link = linkInput.value;
      
      // Tentar usar API moderna
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(link)
          .then(() => {
            alert('‚úÖ Link copiado para a √°rea de transfer√™ncia!');
          })
          .catch(err => {
            // Fallback para m√©todo antigo
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            try {
              document.execCommand('copy');
              alert('‚úÖ Link copiado!');
            } catch (e) {
              alert('‚ùå Erro ao copiar. Copie manualmente: Ctrl+C');
            }
          });
      } else {
        // M√©todo antigo para navegadores mais antigos
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);
        try {
          document.execCommand('copy');
          alert('‚úÖ Link copiado!');
        } catch (err) {
          alert('‚ùå Erro ao copiar. Copie manualmente: Ctrl+C');
        }
      }
    }

    function closeLinkModal() {
      document.getElementById('linkModal').style.display = 'none';
    }

    // Fun√ß√µes para gerenciar hor√°rios
    function openAvailabilityModal(e) {
      if (e) e.preventDefault();
      document.getElementById('availabilityModal').style.display = 'block';
      loadUnavailableSlots();
    }

    function closeAvailabilityModal() {
      document.getElementById('availabilityModal').style.display = 'none';
    }

    function loadUnavailableSlots() {
      fetch('/admin/api/unavailable-slots?password=<%= typeof adminPassword !== "undefined" ? adminPassword : "" %>')
        .then(response => response.json())
        .then(data => {
          const listDiv = document.getElementById('unavailableSlotsList');
          
          if (data.length === 0) {
            listDiv.innerHTML = '<p style="color: #999;">Nenhum hor√°rio/data bloqueada</p>';
            return;
          }
          
          listDiv.innerHTML = data.map(slot => {
            const dateFormatted = new Date(slot.date + 'T00:00:00').toLocaleDateString('pt-BR');
            const timeDisplay = slot.time ? slot.time : 'Data inteira';
            const reason = slot.reason ? ` - ${slot.reason}` : '';
            
            return `
              <div class="slot-item">
                <span>${dateFormatted} - ${timeDisplay}${reason}</span>
                <button onclick="deleteUnavailableSlot(${slot.id})" class="btn-small btn-danger">
                  üóëÔ∏è Remover
                </button>
              </div>
            `;
          }).join('');
        })
        .catch(error => {
          console.error('Erro ao carregar slots:', error);
        });
    }

    function blockTimeSlot() {
      const date = document.getElementById('unavailDate').value;
      const time = document.getElementById('unavailTime').value;
      const reason = document.getElementById('unavailReason').value;
      
      if (!date || !time) {
        alert('‚ö†Ô∏è Por favor, preencha data e hor√°rio');
        return;
      }
      
      fetch('/admin/api/unavailable-slots?password=<%= typeof adminPassword !== "undefined" ? adminPassword : "" %>', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, time, reason })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('‚úÖ Hor√°rio bloqueado com sucesso!');
          document.getElementById('unavailDate').value = '';
          document.getElementById('unavailTime').value = '';
          document.getElementById('unavailReason').value = '';
          loadUnavailableSlots();
        } else {
          alert('‚ùå ' + (data.message || 'Erro ao bloquear hor√°rio'));
        }
      })
      .catch(error => {
        alert('‚ùå Erro ao bloquear hor√°rio');
        console.error(error);
      });
    }

    function blockFullDate() {
      const date = document.getElementById('unavailFullDate').value;
      const reason = document.getElementById('unavailFullReason').value;
      
      if (!date) {
        alert('‚ö†Ô∏è Por favor, selecione uma data');
        return;
      }
      
      fetch('/admin/api/unavailable-dates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date, reason: reason || 'Data bloqueada' })
      })
      .then(res => {
        if (!res.ok) {
          return res.json().then(err => {
            throw new Error(err.error || 'Erro ao bloquear data');
          });
        }
        return res.json();
      })
      .then(data => {
        if (data.success) {
          alert('‚úÖ Data inteira bloqueada!');
          document.getElementById('unavailFullDate').value = '';
          document.getElementById('unavailFullReason').value = '';
          loadUnavailableSlots();
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        alert('‚ùå Erro ao bloquear data: ' + error.message);
      });
    }

    function deleteUnavailableSlot(id) {
      if (!confirm('Tem certeza que deseja remover este bloqueio?')) {
        return;
      }
      
      fetch(`/admin/api/unavailable-slots/${id}?password=<%= typeof adminPassword !== "undefined" ? adminPassword : "" %>`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('‚úÖ Bloqueio removido!');
          loadUnavailableSlots();
        } else {
          alert('‚ùå Erro ao remover bloqueio');
        }
      })
      .catch(error => {
        alert('‚ùå Erro ao remover bloqueio');
        console.error(error);
      });
    }

    // Fun√ß√µes para gerenciar vagas
    function openCapacityModal(e) {
      if (e) e.preventDefault();
      document.getElementById('capacityModal').style.display = 'block';
      loadServiceCapacities();
    }

    function closeCapacityModal() {
      document.getElementById('capacityModal').style.display = 'none';
    }

    function loadServiceCapacities() {
      fetch('/admin/api/service-capacity?password=<%= typeof adminPassword !== "undefined" ? adminPassword : "" %>')
        .then(response => response.json())
        .then(data => {
          const tbody = document.getElementById('capacityTableBody');
          
          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #999;">Nenhuma vaga configurada</td></tr>';
            return;
          }
          
          tbody.innerHTML = data.map(item => `
            <tr>
              <td>${formatServiceName(item.service_name)} - ${item.time_slot}</td>
              <td>
                <input type="number" 
                       id="capacity-${item.id}" 
                       value="${item.capacity}" 
                       min="0" 
                       max="10"
                       style="width: 60px; padding: 4px; text-align: center; border: 2px solid #dee2e6; border-radius: 4px;">
              </td>
              <td>
                <button onclick="updateCapacity(${item.id})" class="btn-small btn-primary">
                  ‚úÖ Salvar
                </button>
              </td>
            </tr>
          `).join('');
        })
        .catch(error => {
          console.error('Erro ao carregar vagas:', error);
          document.getElementById('capacityTableBody').innerHTML = '<tr><td colspan="3" style="text-align: center; color: #dc3545;">Erro ao carregar configura√ß√µes</td></tr>';
        });
    }

    function updateCapacity(id) {
      const input = document.getElementById(`capacity-${id}`);
      const capacity = parseInt(input.value);
      
      if (capacity < 0 || capacity > 10) {
        alert('‚ö†Ô∏è O n√∫mero de vagas deve estar entre 0 e 10');
        return;
      }
      
      fetch(`/admin/api/service-capacity/${id}?password=<%= typeof adminPassword !== "undefined" ? adminPassword : "" %>`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ capacity: capacity })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('‚úÖ Vagas atualizadas com sucesso!');
          loadServiceCapacities();
        } else {
          alert('‚ùå Erro ao atualizar vagas');
        }
      })
      .catch(error => {
        alert('‚ùå Erro ao atualizar vagas');
        console.error(error);
      });
    }

    // Fun√ß√µes para modal de senha
    function openPasswordModal(e) {
      if (e) e.preventDefault();
      document.getElementById('passwordModal').style.display = 'block';
      document.getElementById('passwordForm').reset();
      document.getElementById('passwordMessage').style.display = 'none';
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('passwordForm').reset();
      document.getElementById('passwordMessage').style.display = 'none';
    }

    async function changePassword(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const messageDiv = document.getElementById('passwordMessage');
      
      // Validar no frontend
      if (newPassword !== confirmPassword) {
        messageDiv.textContent = '‚ùå A nova senha e a confirma√ß√£o n√£o coincidem';
        messageDiv.style.backgroundColor = '#ffe6e6';
        messageDiv.style.color = '#c00';
        messageDiv.style.display = 'block';
        return;
      }
      
      if (newPassword.length < 6) {
        messageDiv.textContent = '‚ùå A nova senha deve ter no m√≠nimo 6 caracteres';
        messageDiv.style.backgroundColor = '#ffe6e6';
        messageDiv.style.color = '#c00';
        messageDiv.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch('/admin/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
        });
        
        const data = await response.json();
        
        if (data.success) {
          messageDiv.textContent = '‚úÖ ' + data.message;
          messageDiv.style.backgroundColor = '#e6ffe6';
          messageDiv.style.color = '#060';
          messageDiv.style.display = 'block';
          
          // Limpar formul√°rio
          document.getElementById('passwordForm').reset();
          
          // Fechar modal ap√≥s 2 segundos
          setTimeout(() => {
            closePasswordModal();
          }, 2000);
        } else {
          messageDiv.textContent = '‚ùå ' + data.message;
          messageDiv.style.backgroundColor = '#ffe6e6';
          messageDiv.style.color = '#c00';
          messageDiv.style.display = 'block';
        }
      } catch (error) {
        messageDiv.textContent = '‚ùå Erro ao alterar senha. Tente novamente.';
        messageDiv.style.backgroundColor = '#ffe6e6';
        messageDiv.style.color = '#c00';
        messageDiv.style.display = 'block';
      }
    }

    // Fechar modal ao clicar fora
    window.onclick = function(event) {
      const modals = ['linkModal', 'availabilityModal', 'capacityModal', 'passwordModal'];
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
    }

    // Fechar modais com tecla ESC
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape' || event.key === 'Esc') {
        // Verificar qual modal est√° aberto e fechar
        const modals = ['linkModal', 'availabilityModal', 'capacityModal', 'passwordModal'];
        modals.forEach(modalId => {
          const modal = document.getElementById(modalId);
          if (modal && modal.style.display === 'block') {
            modal.style.display = 'none';
          }
        });
      }
    });
  </script>
  
  <style>
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
</body>
</html>
